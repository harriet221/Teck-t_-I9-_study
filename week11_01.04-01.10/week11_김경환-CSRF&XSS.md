# CSRF & XSS

# CSRF 공격

> CSRF(Cross-Site Request Forgery) - 사이트 간 요청 위조 <br>
> 사용자가 자신의 의지와는 무관하게 공격자가 의도한 행위(수정, 삭제, 등록 등)를 특정 웹사이트에 요청하게 하는 공격을 말한다.

## 쿠키와 세션

CSRF 공격에 대해 설명하기에 앞서 쿠키와 세션에 대한 이해가 필요합니다. 사용자가 특정 서버에 로그인할 경우 일반적으로 다음과 같은 작업들이 수행됩니다.

<img src="https://junhyunny.github.io/images/cross-site-reqeust-forgery-1.JPG" height="400">

1. 서버는 로그인 시 인증된 사용자의 정보를 세션에 저장하고, 이를 찾을 수 있는 `sessionID`를 만듭니다.

2. 서버는 저장된 세션 정보를 `sessionID`라는 이름으로 쿠키에 담아 클라이언트에게 전달합니다.
3. 클라이언트는 전달된 쿠키를 저장합니다.
4. 클라이언트는 해당 도메인을 가진 서버로 요청 시 `sessionID`가 담긴 쿠키를 자동으로 전달하게 됩니다.
5. 서버는 쿠키에 담긴 `sessionID`를 통해 사용자의 인증 여부를 확인합니다.

## CSRF 전제 조건
CSRF 공격이 성립하기 위해선 다음과 같은 조건이 필요합니다.

- 사용자가 보안이 취약한 서버로부터 이미 인증을 받은 상태

- 해당 서버의 요청 방식에 대한 해커의 사전 파악
    - 예상치 못한 파라미터가 있을 시 불가능

- 쿠키를 기반으로 인증 정보를 전달하는 방식의 서버

## CSRF 공격 과정
위와 같은 조건이 만족될 경우 다음과 같은 과정을 통해 CSRF 공격이 수행됩니다.

1. 해당 서버에 로그인합니다.

2. 사용자의 클라이언트에 `sessionID`가 담긴 쿠키가 저장됩니다.
3. 해커는 서버에 인증된 클라이언트의 사용자가 악성 스크립트 페이지를 누르도록 유도합니다.
4. 해당 페이지를 누를 경우 쿠키에 저장되있던  `sessionID`가 클라이언트에 의해 자동적으로 함께 서버로 요청됩니다.
5. 서버는 쿠키에 담긴 `sessionID`를 통해 해당 요청이 인증된 사용자로부터 온 것으로 판단하고 처리합니다.

## CSRF 방어 기법

### Referer 검증

이 방식에선 http 헤더 중 하나인 `Referer` 헤더와 `host` 헤더가 사용됩니다.

- Referer
    - 웹 페이지 요청 시 해당 요청이 어떤 웹 페이지에서 발생했는지를 나타내는 정보

- host
    - 하나의 IP 주소에 여러 도메인이 적용되었을 때 해당 요청들을 나누기 위해 사용되는 정보

보통 `host`와 `Referer` 값이 일치하기 때문에 이 둘을 비교하는 방법입니다. CSRF 공격의 대부분은 이 방식으로 방어가 가능하다고 합니다.

# XSS 공격

XSS란 Cross Site Scripting의 약자로, 다른 사용자들과 공유하는 사이트에 명령어 코드, 즉 스크립트 코드를 주입하는 것을 뜻한다.

## 상황

보안 장치가 없는 게시판이 있다고 할 경우

누군가 게시글의 내용으로 html코드를 입력한다면 내용은 아래와 같을 것이다.

<img src="https://i.imgur.com/SdA1aDZ.png" width="" height="400"> 

일반적인 유저의 입장에서 위 코드는 문제가 없어보일 수도 있지만 개발자의 입장에선 다르다. 

## 문제

아래는 실제 브라우저가 받는 html 코드다.

<img src="https://i.imgur.com/nO1fQZS.png" width="" height="400">

브라우저는 이때 이 게시물의 내용까지도 해당 페이지의 자바스크립트 코드로 인식하고 실행하게 된다.

이 부분을 막아 놓지 않는다면 쉽게 악의적인 공격이 가능해진다

가령 이런 스크립트 활용을 통해 해당 게시글을 조회하는 유저의 로그인 정보가 담긴 쿠키를 해커에게 보내는 코드를 작동시키게 할 수 있다.

또한 스크립트 태그 내에서 실행하는 것 뿐 아니라 링크 태그에 집어넣어서 실행되도록 하는 등 다양한 태그를 활용한 다양한 악의적 접근 방법이 존재한다.

## 대비

게시물 내의 태그들을 모두 치환해버릴 경우 문제가 해결될 순 있으나 이 경우 html 요소를 게시물 내용으로 사용할 수가 없어지기 때문에 다른 방식으로 접근해야한다.

- 게시글에 작성된 스크립트가 실행되는 것을 방지

- 서버 DB에 이런 스크립트가 저장되는 것을 사전에 차단
- 사용자 정보가 담긴 쿠키는 http only 속성을 걸어 자바스크립트로의 접근 차단
- 서버에 들어오는 요청들 중 위험한 요소를 걸러주는 XSS 필터를 사용
    - 전문가들에게 검증 받은 화이트리스트 라이브러리를 사용함으로써 XSS 필터를 어렵지 않게 구현이 가능하다.

<sub>참고 문헌

- https://junhyunny.github.io/information/security/spring-boot/spring-security/cross-site-reqeust-forgery/
- https://www.youtube.com/watch?v=dHcjwTvrxTk&ab_channel=%EC%96%84%ED%8C%8D%ED%95%9C%EC%BD%94%EB%94%A9%EC%82%AC%EC%A0%84</sub>